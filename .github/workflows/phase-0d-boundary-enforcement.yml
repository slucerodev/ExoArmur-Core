name: ExoArmur Phase 0D Boundary Enforcement

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  boundary-gate:
    runs-on: ubuntu-latest
    name: Boundary Gate (Determinism + Fixture Scopes)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Run Boundary Gate
      run: |
        python scripts/boundary_gate.py
    
    - name: Upload boundary gate results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: boundary-gate-results
        path: |
          /tmp/test_report.json
          boundary-gate.log

  protocol-enforcer-boundary:
    runs-on: ubuntu-latest
    name: Protocol Enforcer Boundary Check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Run Protocol Enforcer Boundary Check
      run: |
        python scripts/protocol_enforcer_boundary.py
    
    - name: Upload protocol enforcer results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: protocol-enforcer-results
        path: protocol-enforcer.log

  test-collection-stability:
    runs-on: ubuntu-latest
    name: Test Collection Stability
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Check test collection count
      run: |
        echo "Checking test collection stability..."
        COLLECTED=$(python -m pytest --collect-only -q | tail -1)
        echo "Collected: $COLLECTED"
        
        if [[ "$COLLECTED" != *"417 tests collected"* ]]; then
          echo "❌ Test collection count changed from expected 417"
          echo "   Expected: 417 tests collected"
          echo "   Actual: $COLLECTED"
          exit 1
        fi
        
        echo "✅ Test collection count stable: 417 tests"

  full-test-suite:
    runs-on: ubuntu-latest
    name: Full Test Suite (Optional)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Run full test suite
      run: |
        echo "Running full test suite..."
        python -m pytest tests/ --tb=short --junitxml=test-results.xml
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: full-test-results
        path: test-results.xml
